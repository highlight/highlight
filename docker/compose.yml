services:
    redpanda:
        container_name: highlight-redpanda
        image: docker.redpanda.com/vectorized/redpanda:v22.3.8
        command:
            - redpanda start
            - --smp 1
            - --overprovisioned
            - --node-id 0
            - --kafka-addr PLAINTEXT://0.0.0.0:29092,OUTSIDE://0.0.0.0:9092
            - --advertise-kafka-addr PLAINTEXT://redpanda:29092,OUTSIDE://localhost:9092
            - --pandaproxy-addr 0.0.0.0:8082
            - --advertise-pandaproxy-addr localhost:8082
            - --memory 1G
            - --reserve-memory 0M
            - --check=false
            - --set redpanda.empty_seed_starts_cluster=true
            - --set redpanda.enable_sasl=true
            - --set redpanda.superusers=["dev"]
            - --set redpanda.kafka_batch_max_bytes=536870912
            - --set redpanda.kafka_request_max_bytes=536870912

    redis:
        container_name: highlight-redis
        image: redis
        volumes:
            - redis-data:/data
        command:
            - redis-server
            - --save 60 1
            - --loglevel warning

    postgres:
        container_name: highlight-postgres
        image: postgres
        ports:
            - 5432:5432
        environment:
            POSTGRES_HOST_AUTH_METHOD: trust
        volumes:
            - postgres-data:/var/lib/postgresql/data

    collector:
        container_name: highlight-collector
        image: otel/opentelemetry-collector
        ports:
            - 4317:4317
        command:
            - '--config=/etc/otel-collector-config.yaml'
        volumes:
            - ./otel-collector.yaml:/etc/otel-collector-config.yaml

    backend:
        container_name: highlight-backend
        image: highlight.io/backend
        ports:
            - 8082:8082
        build:
            context: ..
            dockerfile: docker/backend.Dockerfile
        environment:
            - DEMO_SESSION
            - DEPLOYMENT_KEY
            - ENVIRONMENT
            - FIREBASE_SECRET
            - FRONTEND_URI
            - INFLUXDB_BUCKET
            - INFLUXDB_ORG
            - KAFKA_SASL_PASSWORD=
            - KAFKA_SASL_USERNAME=dev
            - KAFKA_SERVERS=highlight-redpanda:9092
            - KAFKA_TOPIC=dev
            - PSQL_DB=postgres
            - PSQL_HOST=highlight-postgres
            - PSQL_PASSWORD=
            - PSQL_PORT=5432
            - PSQL_USER=postgres
            - PUBLIC_GRAPH_URI
            - REDIS_ADDRESS=highlight-redis:6379
            - REDIS_EVENTS_STAGING_ENDPOINT=highlight-redis:6379
            - SESSION_FILE_PATH_PREFIX

    frontend:
        container_name: highlight-frontend
        image: highlight.io/frontend
        ports:
            - 3000:443
        build:
            context: ..
            dockerfile: docker/frontend.Dockerfile
            args:
                - REACT_APP_DEMO_SESSION
                - REACT_APP_ENVIRONMENT
                - REACT_APP_FIREBASE_CONFIG_OBJECT
                - REACT_APP_FRONTEND_ORG
                - REACT_APP_FRONTEND_URI
                - REACT_APP_ONPREM
                - REACT_APP_PRIVATE_GRAPH_URI
                - REACT_APP_PUBLIC_GRAPH_URI
        environment:
            - RENDER_PREVIEW=true

volumes:
    postgres-data:
    redis-data:
